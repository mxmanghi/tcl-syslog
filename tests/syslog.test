#!/usr/bin/env tclsh

set auto_path [concat "." $auto_path]

package require tcltest
package require syslog

# Generate unique message
set testMessage "TCLTEST-SYSLOG-[clock seconds]"
set syslogFile  "/var/log/syslog"
set journalctl [auto_execok journalctl]

# Setup: no specific action needed
::tcltest::test syslog-1.0 {Log message should appear in syslog} -setup {
    # Send the message
    if {[catch { syslog -pid -ident test_ident -facility local2 critical $testMessage } e einfo]} {
        puts "Error calling syslog: $e"
    }
    # Give syslog some time to flush
    after 1000
} -body {
    set found 0

    if { [file readable $syslogFile] } {
        if { [catch { exec grep -F -- $testMessage $syslogFile } e einfo] } {
            if { [lindex $::errorCode 0] ne "CHILDSTATUS" || [lindex $::errorCode 2] != 1 } {
                puts "Error searching '$syslogFile' ($e)"
                puts $einfo
            }
        } else {
            set found 1
        }
    } elseif { $journalctl ne "" } {
        if { [catch { set output [exec $journalctl -t test_ident --since "1 minute ago" --no-pager] } e einfo] } {
            puts "Error querying journalctl ($e)"
            puts $einfo
        } elseif { [string first $testMessage $output] >= 0 } {
            set found 1
        }
    } else {
        puts "No readable syslog file and journalctl not available"
    }

    set found
} -cleanup {
    # Nothing to clean, since syslog rotates naturally
    # You *could* truncate or remove the line with sed, but avoid on production systems
} -result 1


::tcltest::cleanupTests
